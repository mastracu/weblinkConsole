<!DOCTYPE html>
<html>
<head>
<style>
.tabArea {
    height: 20px;
    box-sizing: border-box;
    border-bottom: 1px solid #999;  
}
.tab {
	height: 20px;
	line-height: 20px;
	box-sizing: border-box;
	color: #999;
	padding: 0 8px;
	border: 1px solid #999;
	border-bottom: 0;
	cursor: pointer;
	float: left;
}
.tab.active {
	color: black;
	border-bottom: 1px solid white;
}
.editor-container {
	border: 1px solid #999;
	border-top: 0;
}

</style>
</head>
<body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.min.js" integrity="sha256-0SGl1PJNDyJwcV5T+weg2zpEMrh7xvlwO4oXgvZCeZk=" crossorigin="anonymous"></script>

    <script>

        require.config({ paths: { 'vs': './node_modules/monaco-editor/min/vs' } });

        require(['vs/editor/editor.main'], function () {

            monaco.languages.register({ id: 'zpl' });

            // Register a tokens provider for the language
            monaco.languages.setMonarchTokensProvider('zpl', {
                tokenizer: {
                    root: [
                        [/\^(A@?|[B-Z][A-Z0-9])/, "zplcmd", "insidecmd"],
                        [/~[A-Z][A-Z0-9]/, "zpltilde", "insidecmd"],
                    ],
                    insidecmd: [
                        [/.*?(?=[\\^~])/, "parms", "root"],
                        [/.*?(?=$)/, "parms", "root"],
                    ]
                }
            });

            // Define a new theme that contains only rules that match this language
            monaco.editor.defineTheme('myCoolTheme', {
                base: 'vs',
                inherit: false,
                rules: [
                    { token: 'zplcmd', foreground: 'ff0000', fontStyle: 'bold' },
                    { token: 'zpltilde', foreground: 'FFA500' },
                    { token: 'parms', foreground: '087c4c' },
                ]
            });

            monaco.languages.registerHoverProvider('zpl', {
                provideHover: function (model, position) {
                    var currentLine = model.getLineContent(position.lineNumber);
                    var textTokens = monaco.editor.tokenize(currentLine, "zpl");
                    var lineTokensCount = textTokens[0].length;
                    var selToken = null;
                    var selTokenEnd = null;
                    for (var i = 0; i < lineTokensCount; i++) {
                        if (textTokens[0][i].type == "zplcmd.zpl" || textTokens[0][i].type == "zpltilde.zpl") {
                            if (textTokens[0][i].offset < position.column) {
                                selToken = textTokens[0][i];

                            } else {
                                if (selTokenEnd === null && selToken) {
                                    selTokenEnd = textTokens[0][i].offset;
                                };
                            };
                        };
                    };


                    if (selToken) {
                        if (selTokenEnd === null) {
                            selTokenEnd = model.getLineMaxColumn(position.lineNumber);
                        }
                        var selText = currentLine.substr(selToken.offset, selTokenEnd - selToken.offset);
                        console.log("selText:" + selText);

                        return xhr('https://kotlin-rain.appspot.com/zpl', selText).then(function (res) {
                            return {
                                // range: new monaco.Range(1, 1, model.getLineCount(), model.getLineMaxColumn(model.getLineCount())),
                                range: new monaco.Range(position.lineNumber, selToken.offset, position.lineNumber, selTokenEnd),
                                contents: [
                                    { value: '**' + selText + '**' },
                                    { value: '```html\n' + res.responseText + '\n```' }
                                ]
                            }
                        });
                    }

                }
            });


        });

        var editor = null;
        var data = {
            zpl1: {
                model: null,
                state: null
            },
            zpl2: {
                model: null,
                state: null
            },
            zpl3: {
                model: null,
                state: null
            }
        };

        function zplCode() {
            return [
                '~JC',
                '^XA',
                '^CF0,190',
                '^A0,20^FO485,965',
                '^FDCA^FS',
                '^XZ'
            ].join('\n');;
        };

        function rfidZplCode() {
            return [
                '^XA',
                '^HL',
                'PQ2',
                '^RS8,B8^RW16,20',
                '^RU',
                '^FO30,50^A0N,30^FN1^FS',
                '^FO30,100^A0N,30^FN2^FS',
                '^FO30,140^BY2^BCN,100,N,N,N^FN2^FS',
                '^FN1^FDUnique 38 bits from TID: #H^FS',
                '^FN2^FD#F^FS',
                '^RFW,H^FD#F^FS',
                '^HV1,,,,L',
                '^XZ'
            ].join('\n');;
        };

        function xhr(url, key) {
            var req = null;
            return new Promise(function (c, e) {
                req = new XMLHttpRequest();
                req.onreadystatechange = function () {
                    if (req._canceled) { return; }

                    if (req.readyState === 4) {
                        if ((req.status >= 200 && req.status < 300) || req.status === 1223) {
                            c(req);
                        } else {
                            e(req);
                        }
                        req.onreadystatechange = function () { };
                    }
                };

                req.open("POST", url, true);
                req.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");

                req.responseType = "";

                req.send(key);
            }, function () {
                req._canceled = true;
                req.abort();
            });
        }

        function layout() {
            var GLOBAL_PADDING = 20;

            var WIDTH = window.innerWidth - 2 * GLOBAL_PADDING;
            var HEIGHT = window.innerHeight;

            var TITLE_HEIGHT = 110;
            var FOOTER_HEIGHT = 80;
            var TABS_HEIGHT = 20;
            var INNER_PADDING = 20;
            var SWITCHER_HEIGHT = 30;

            var HALF_WIDTH = Math.floor((WIDTH - INNER_PADDING) / 2);
            var REMAINING_HEIGHT = HEIGHT - TITLE_HEIGHT - FOOTER_HEIGHT - SWITCHER_HEIGHT;

            typingContainer.style.position = 'absolute';
            typingContainer.style.top = GLOBAL_PADDING + TITLE_HEIGHT + SWITCHER_HEIGHT + 'px';
            typingContainer.style.left = GLOBAL_PADDING + 'px';
            typingContainer.style.width = HALF_WIDTH + 'px';
            typingContainer.style.height = REMAINING_HEIGHT + 'px';

            tabArea.style.position = 'absolute';
            tabArea.style.boxSizing = 'border-box';
            tabArea.style.top = 0;
            tabArea.style.left = 0;
            tabArea.style.width = HALF_WIDTH + 'px';
            tabArea.style.height = TABS_HEIGHT + 'px';

            editorContainer.style.position = 'absolute';
            editorContainer.style.boxSizing = 'border-box';
            editorContainer.style.top = TABS_HEIGHT + 'px';
            editorContainer.style.left = 0;
            editorContainer.style.width = HALF_WIDTH + 'px';
            editorContainer.style.height = (REMAINING_HEIGHT - TABS_HEIGHT) + 'px';
        }

        function changeTab(selectedTabNode, desiredModelId) {
            for (var i = 0; i < tabArea.childNodes.length; i++) {
                var child = tabArea.childNodes[i];
                if (/tab/.test(child.className)) {
                    child.className = 'tab';
                }
            }
            selectedTabNode.className = 'tab active';

            require(['vs/editor/editor.main'], function () {

                var currentState = editor.saveViewState();

                var currentModel = editor.getModel();
                if (currentModel === data.zpl1.model) {
                    data.zpl1.state = currentState;
                } else if (currentModel === data.zpl2.model) {
                    data.zpl2.state = currentState;
                } else if (currentModel === data.zpl3.model) {
                    data.zpl3.state = currentState;
                }

                editor.setModel(data[desiredModelId].model);
                editor.restoreViewState(data[desiredModelId].state);
                editor.focus();
            });
        }

        // create the typing side
        var typingContainer = document.createElement('div');
        typingContainer.className = 'typingContainer';

        var tabArea = (function () {
            var tabArea = document.createElement('div');
            tabArea.className = 'tabArea';

            var jsTab = document.createElement('span');
            jsTab.className = 'tab active';
            jsTab.appendChild(document.createTextNode('1.ZPL'));
            jsTab.onclick = function () { changeTab(jsTab, 'zpl1'); };
            tabArea.appendChild(jsTab);

            var cssTab = document.createElement('span');
            cssTab.className = 'tab';
            cssTab.appendChild(document.createTextNode('2.ZPL'));
            cssTab.onclick = function () { changeTab(cssTab, 'zpl2'); };
            tabArea.appendChild(cssTab);

            var htmlTab = document.createElement('span');
            htmlTab.className = 'tab';
            htmlTab.appendChild(document.createTextNode('3.ZPL'));
            htmlTab.onclick = function () { changeTab(htmlTab, 'zpl3'); };
            tabArea.appendChild(htmlTab);

            return tabArea;
        })();

        var editorContainer = document.createElement('div');
        editorContainer.className = 'editor-container';

        typingContainer.appendChild(tabArea);
        typingContainer.appendChild(editorContainer);

        layout();
        window.onresize = layout;

        document.body.appendChild(typingContainer);

        require(['vs/editor/editor.main'], function () {

            data.zpl1.model = monaco.editor.createModel(zplCode(), 'zpl');
            data.zpl2.model = monaco.editor.createModel(rfidZplCode(), 'zpl');
            data.zpl3.model = monaco.editor.createModel('~JC', 'zpl');

            editor = monaco.editor.create(editorContainer, {
                model: data.zpl1.model,
                theme: 'myCoolTheme',
                minimap: {
                    enabled: false
                }
            });
        });

    </script>
</body>